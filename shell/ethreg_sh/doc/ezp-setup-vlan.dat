#!/bin/sh
. /etc/network.sh
. /etc/functions.sh

# Iterate vlanport_rule
local vnum="$(nvram get vlanport_rule_max)"
local i=0
local tag="";
local temp;

LAN_WAN_Par_Init()
{
    echo "LAN_WAN_Par_Init..." >>/dev/console
    #P0~P4 lan port, P5 wan port
    #802.1Q check mode 
    esw_mgr -s -r 0x660 -v 0x0014027e
    esw_mgr -s -r 0x66c -v 0x0014027d
    esw_mgr -s -r 0x678 -v 0x0014027b
    esw_mgr -s -r 0x684 -v 0x00140277
    esw_mgr -s -r 0x690 -v 0x0014026f
    esw_mgr -s -r 0x69c -v 0x0014025f
    #set P0~P4 CVID=1
    esw_mgr -s -r 0x420 -v 0x00010001
    esw_mgr -s -r 0x428 -v 0x00010001
    esw_mgr -s -r 0x430 -v 0x00010001
    esw_mgr -s -r 0x438 -v 0x00010001
    esw_mgr -s -r 0x440 -v 0x00010001

if [ "$(nvram show wl_mode_rule 0 mode)" = "normal" ]; then 
    #switch reg w 98 7f1f
    #switch greg w 108 c03e0001
    //add by alan
    echo "Router mode" >>/dev/console
    esw_mgr -s -r 0x448 -v 0x00020001
    esw_mgr -s -r 0x610 -v 0x001bd560
    esw_mgr -s -r 0x614 -v 0x80010002
    esw_mgr -s -r 0x610 -v 0x001b7fe0
    esw_mgr -s -r 0x614 -v 0x80020002
else
    //add by alan
    #switch reg w 98 7f3f
    #switch greg w 108 3e0001
    echo "AP mode" >>/dev/console
    esw_mgr -s -r 0x448 -v 0x00010001
    esw_mgr -s -r 0x610 -v 0x001B5560
    esw_mgr -s -r 0x614 -v 0x80010002
fi

}


while [ "$i" -lt "$vnum" ];
do
      portid="$(nvram show vlanport_rule $i portid)"
      pvid="$(nvram show vlanport_rule $i pvid)"
      temp="$(nvram show vlanport_rule $i tag)"
      gmemb="$(nvram show vlanport_rule $i gmemb)"
      tag="$tag$temp"
      #set up the switch IC           
      switch vlan port $portid $pvid
      [ -n "$gmemb" ] && switch gport "$portid" "$pvid" "$gmemb"
      #vlan group index
      i="$(($i + 1))"
done

LAN_WAN_Par_Init

# Iterate vlan_rule 
vnum="$(nvram get vlan_rule_num)"
i=0
local idx=0
local enable=0
while [ "$i" -lt "$vnum" ];
do
    enable="$(nvram show vlan_rule $i enable)"
    [ "$enable" = "1" ] && { 
    	vid="$(nvram show vlan_rule $i vid)"
	    portmember="$(nvram show vlan_rule $i portmember)"
    	tag="$(nvram show vlan_rule $i tag)"
	    # set up the switch IC
    	switch vlan set $idx $vid $portmember $tag
	    # set up linux vlan by vconfig
    	if_valid vlan${vid} ${i}
	    # vlan group index
    	idx="$(($idx + 1))"
    }
    i="$(($i + 1))"
done

